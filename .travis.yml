dist: trusty
services:
- docker
language: node_js
env:
- TZ=America/New_York
cache: yarn
branches:
  only:
  - develop
  - "/^production\\//"
  - "/^staging\\//"
before_install:
- npm install -g yarn@`jq -r .engines.yarn package.json`
stages:
- name: test
  if: branch !~ /^staging\//
- name: deploy
  if: branch =~ /^(production|staging)\//  AND type IN (push)
jobs:
  include:
  - stage: test
    if: type IN (push)
    install: yarn install --frozen-lockfile
    script: yarn run test
  - if: type IN (pull_request)
    install:
    - yarn install --frozen-lockfile --ignore-scripts
    - lerna run --stream --since $TRAVIS_PULL_REQUEST_SHA^1 --include-filtered-dependencies
      prepare
    script: yarn run test:since $TRAVIS_PULL_REQUEST_SHA^1
  - stage: deploy
    install:
    - yarn install --frozen-lockfile --ignore-scripts
    - npx lerna run --stream --scope @cityofboston/deploy-tools --include-filtered-dependencies
      prepare
    script: skip
    deploy:
      provider: script
      skip_cleanup: true
      script: deploy/travis-deploy.sh
      on:
        all_branches: true
notifications:
  slack:
    rooms:
      secure: AC039Rc34u59zEiO7zmPyzd4ii9QnL0Xf6o0YGQf37GJlJCTv712I4aOFZRWIkTLZfjH3vURNvwTDoTpx6PgAMu1bIcet1LGjsoYcjN7xXqPfqi7peXANEnVZzlUpGRkP8Y6TV3nYaE0g0gpuEqORm0Bgs7zgeCNiWNT35vPtvzc9U8E/Zx4nzYEzXJr1SWwBtM/E1bhGaIKzy338AJj9ZJOnxV3Qng7LYIOmkuxwTqLfJWNBd8Wj2pAP/HQ4XfFtcgEqfYwhtjGNYfLbDVJjdiul3UJ9/C4gHkfGEhhsfgyZjqJTRsZCZABWPsqZ5a+7diNXjUOuVyG2HwBIy2/9L6UnsA1y79HOVQ8k0tj7z8iXD36OSvv7bCCVyC7ymz7ViLld/moKYHCfHTNd/g6ES1eDbNiybg6gx3eIvgDIey0GNl5kjw8vIMb/3SNMSm/zZCrv4/DUZgei8xYjsEM6j1VUVVwhn6E6yOuMRgAuXUPO/w61w+lf+rgQZNfBS8+K/lZ0OQdb1eHWmUKL4EtqFuOpsrBbt0PCT3Rygb/O+eUSba7BcvUDDoYuah2rQmylR4kPQNYmLZgukwta+CZrLb988zR/vsGV6THtnluF3/kZm9v0SMXGqZQNgILwaV4ie0WsoAArWFd2A2CtKmVx4q9LYwNylb0pDr93zfDaN8=
